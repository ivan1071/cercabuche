<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ef4444">
    <title>RoadBumps Tracker</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        
        #map {
            height: 50vh;
            width: 100%;
            z-index: 1;
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .bump-alert {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        
        .sensor-bar {
            transition: width 0.1s ease;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <div class="glass-panel shadow-lg z-20 px-4 py-3 flex items-center justify-between border-b border-gray-200">
        <div class="flex items-center gap-2">
            <div class="bg-red-500 text-white p-2 rounded-lg">
                <i data-lucide="alert-triangle" class="w-5 h-5"></i>
            </div>
            <div>
                <h1 class="font-bold text-gray-800 text-lg leading-tight">RoadBumps</h1>
                <p class="text-xs text-gray-500">Rilevatore dissesti stradali</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <div id="status-indicator" class="w-3 h-3 rounded-full bg-gray-400"></div>
            <span id="status-text" class="text-xs font-medium text-gray-600">Standby</span>
        </div>
    </div>

    <!-- Mappa -->
    <div id="map" class="shadow-inner"></div>

    <!-- Pannello Controlli -->
    <div class="flex-1 glass-panel flex flex-col overflow-hidden">
        
        <!-- Toolbar -->
        <div class="p-4 border-b border-gray-200 flex gap-2 overflow-x-auto">
            <button id="btn-main" onclick="toggleMain()" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-xl flex items-center justify-center gap-2 transition-all active:scale-95 shadow-lg shadow-green-500/30">
                <i data-lucide="play" class="w-5 h-5"></i>
                <span>Avvia</span>
            </button>
            
            <button id="btn-stop" onclick="stopAll()" class="hidden bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-4 rounded-xl flex items-center gap-2 transition-all active:scale-95">
                <i data-lucide="x" class="w-5 h-5"></i>
                <span>Termina</span>
            </button>
            
            <button onclick="exportData()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-xl flex items-center gap-2 transition-all active:scale-95 shadow-lg shadow-blue-500/30">
                <i data-lucide="download" class="w-5 h-5"></i>
            </button>
            
            <button onclick="clearData()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-4 rounded-xl flex items-center gap-2 transition-all active:scale-95">
                <i data-lucide="trash-2" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- Sensori Live -->
        <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
            <div class="flex items-center justify-between mb-2">
                <span class="text-xs font-semibold text-gray-600 uppercase tracking-wider">Intensità Scossa</span>
                <span id="g-force" class="text-sm font-bold text-gray-800">0.0g</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                <div id="intensity-bar" class="sensor-bar bg-gradient-to-r from-green-400 via-yellow-400 to-red-500 h-full rounded-full" style="width: 0%"></div>
            </div>
            <div class="flex justify-between mt-1 text-xs text-gray-400">
                <span>Lieve</span>
                <span>Moderata</span>
                <span>Forte</span>
            </div>
        </div>

        <!-- Lista Dissesti -->
        <div class="flex-1 overflow-y-auto p-4 space-y-3" id="bumps-list">
            <div class="text-center text-gray-400 py-8">
                <i data-lucide="map-pin" class="w-12 h-12 mx-auto mb-2 opacity-20"></i>
                <p class="text-sm">Nessun dissesto rilevato</p>
                <p class="text-xs mt-1">Avvia il tracking per iniziare</p>
            </div>
        </div>

        <!-- Alert Banner -->
        <div id="alert-banner" class="hidden bg-red-500 text-white p-4 shadow-lg">
            <div class="flex items-center gap-3">
                <i data-lucide="alert-octagon" class="w-6 h-6 animate-bounce"></i>
                <div class="flex-1">
                    <p class="font-bold" id="alert-title">ATTENZIONE!</p>
                    <p class="text-sm opacity-90" id="alert-desc">Rallentare</p>
                </div>
                <button onclick="hideAlert()" class="p-1 hover:bg-white/20 rounded">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // Stati
        let isRecording = false; // Accelerometro attivo
        let isNavigating = false; // GPS attivo
        
        // Variabili
        let map, userMarker, pathLine;
        let accelerometer = null;
        let geolocationId = null;
        let detectedBumps = [];
        let currentPosition = null;
        let pathCoordinates = [];
        let lastPosition = null;
        let currentSpeed = 0;
        let proximityCheckInterval;
        let lastBumpTime = 0;

        // Costanti
        const BUMP_THRESHOLD = 25; // 2.5g - solo sussulti medi/gravi
        const COOLDOWN_MS = 4000;
        const CLUSTER_RADIUS = 15; // metri
        const BASE_WARNING_DISTANCE = 200;

        // Caricamento dati
        try {
            const stored = localStorage.getItem('roadBumps');
            if (stored) {
                const parsed = JSON.parse(stored);
                if (Array.isArray(parsed)) {
                    detectedBumps = parsed.filter(b => b && b.id && typeof b.lat === 'number' && typeof b.lng === 'number');
                }
            }
        } catch (e) {
            detectedBumps = [];
        }

        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            renderBumpsList();
        });

        function initMap() {
            map = L.map('map').setView([41.9028, 12.4964], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap',
                maxZoom: 19
            }).addTo(map);

            detectedBumps.forEach(bump => {
                if (bump && bump.lat && bump.lng) addBumpMarker(bump);
            });
        }

        // Gestione 3 stati
        async function toggleMain() {
            if (!isNavigating && !isRecording) {
                // Standby -> Registrazione (avvia tutto)
                await startRecordingAndNav();
            } else if (isRecording) {
                // Registrazione -> Navigazione (ferma solo accel)
                stopRecordingOnly();
            } else if (isNavigating && !isRecording) {
                // Navigazione -> Riprendi Registrazione
                await startRecordingOnly();
            }
            updateUI();
        }

        function updateUI() {
            const btnMain = document.getElementById('btn-main');
            const btnStop = document.getElementById('btn-stop');
            const statusInd = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            
            btnMain.className = 'flex-1 font-semibold py-3 px-4 rounded-xl flex items-center justify-center gap-2 transition-all active:scale-95 shadow-lg';
            
            if (!isNavigating && !isRecording) {
                // STANDBY
                btnMain.innerHTML = '<i data-lucide="play" class="w-5 h-5"></i><span>Avvia</span>';
                btnMain.classList.add('bg-green-500', 'hover:bg-green-600', 'text-white', 'shadow-green-500/30');
                btnStop.classList.add('hidden');
                statusInd.className = 'w-3 h-3 rounded-full bg-gray-400';
                statusText.textContent = 'Standby';
                
            } else if (isRecording) {
                // REGISTRAZIONE
                btnMain.innerHTML = '<i data-lucide="square" class="w-5 h-5"></i><span>Stop</span>';
                btnMain.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white', 'shadow-red-500/30');
                btnStop.classList.remove('hidden');
                statusInd.className = 'w-3 h-3 rounded-full bg-green-500 animate-pulse';
                statusText.textContent = 'Registrazione...';
                
            } else if (isNavigating && !isRecording) {
                // NAVIGAZIONE (solo avvisi)
                btnMain.innerHTML = '<i data-lucide="refresh-cw" class="w-5 h-5"></i><span>Riprendi</span>';
                btnMain.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white', 'shadow-blue-500/30');
                btnStop.classList.remove('hidden');
                statusInd.className = 'w-3 h-3 rounded-full bg-blue-500 animate-pulse';
                statusText.textContent = 'Navigazione attiva';
            }
            
            lucide.createIcons();
        }

        async function startRecordingAndNav() {
            if (!navigator.geolocation) throw new Error('Geolocalizzazione non supportata');
            
            // Avvia GPS
            geolocationId = navigator.geolocation.watchPosition(
                (position) => {
                    const newPos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        timestamp: Date.now(),
                        speed: position.coords.speed
                    };
                    
                    if (lastPosition && !newPos.speed) {
                        const dist = calculateDistance(lastPosition.lat, lastPosition.lng, newPos.lat, newPos.lng);
                        const timeDiff = (newPos.timestamp - lastPosition.timestamp) / 1000;
                        if (timeDiff > 0) currentSpeed = (dist / timeDiff) * 3.6;
                    } else if (newPos.speed) {
                        currentSpeed = newPos.speed * 3.6;
                    }
                    
                    currentPosition = newPos;
                    lastPosition = newPos;
                    updateUserPosition(newPos);
                    
                    pathCoordinates.push([newPos.lat, newPos.lng]);
                    if (pathLine) {
                        pathLine.setLatLngs(pathCoordinates);
                    } else {
                        pathLine = L.polyline(pathCoordinates, {color: 'blue', weight: 4, opacity: 0.7}).addTo(map);
                    }
                },
                (err) => console.error('GPS Error:', err),
                { enableHighAccuracy: true, maximumAge: 1000, timeout: 5000 }
            );
            
            // Avvia Accelerometro
            await startAccelerometer();
            
            // Avvia controllo prossimità
            proximityCheckInterval = setInterval(checkProximity, 3000);
            
            isRecording = true;
            isNavigating = true;
        }

        async function startRecordingOnly() {
            // Riattiva solo accelerometro (GPS già attivo)
            await startAccelerometer();
            isRecording = true;
        }

        function stopRecordingOnly() {
            // Ferma solo accelerometro, GPS rimane attivo per navigazione
            if (accelerometer) {
                accelerometer.stop();
                accelerometer = null;
            }
            isRecording = false;
            // isNavigating rimane true!
        }

        function stopAll() {
            // Ferma tutto
            isNavigating = false;
            isRecording = false;
            
            if (geolocationId) {
                navigator.geolocation.clearWatch(geolocationId);
                geolocationId = null;
            }
            
            if (accelerometer) {
                accelerometer.stop();
                accelerometer = null;
            }
            
            if (proximityCheckInterval) {
                clearInterval(proximityCheckInterval);
                proximityCheckInterval = null;
            }
            
            updateUI();
            hideAlert();
        }

        async function startAccelerometer() {
            if ('Accelerometer' in window) {
                try {
                    if (navigator.permissions) {
                        const result = await navigator.permissions.query({ name: 'accelerometer' });
                        if (result.state === 'denied') throw new Error('Permesso negato');
                    }
                    
                    accelerometer = new Accelerometer({ frequency: 60 });
                    accelerometer.addEventListener('reading', () => {
                        processAccelerometerData(accelerometer.x, accelerometer.y, accelerometer.z);
                    });
                    accelerometer.start();
                } catch (e) {
                    console.warn('Accelerometro non disponibile:', e);
                }
            }
        }

        function processAccelerometerData(x, y, z) {
            if (!currentPosition) return;
            
            const verticalAccel = Math.abs((z || 0) - 9.8);
            const intensity = Math.min((verticalAccel / 20) * 100, 100);
            
            document.getElementById('intensity-bar').style.width = intensity + '%';
            document.getElementById('g-force').textContent = (verticalAccel / 9.8).toFixed(1) + 'g';
            
            const now = Date.now();
            if (verticalAccel > BUMP_THRESHOLD && (now - lastBumpTime > COOLDOWN_MS)) {
                lastBumpTime = now;
                registerBump(currentPosition, verticalAccel);
            }
        }

        function registerBump(position, intensity) {
            const now = Date.now();
            
            // Clustering
            const recentDuplicate = detectedBumps.find(b => {
                const dist = calculateDistance(position.lat, position.lng, b.lat, b.lng);
                const timeDiff = now - b.id;
                return dist < CLUSTER_RADIUS && timeDiff < 10000;
            });
            
            if (recentDuplicate) {
                if (intensity > recentDuplicate.intensity) {
                    recentDuplicate.intensity = intensity;
                    recentDuplicate.type = intensity > 35 ? 'buca_profonda' : (intensity > 25 ? 'dosso' : 'sussulto_medio');
                    localStorage.setItem('roadBumps', JSON.stringify(detectedBumps));
                    renderBumpsList();
                }
                return;
            }
            
            let type = 'sussulto_medio';
            if (intensity > 35) type = 'buca_profonda';
            else if (intensity > 25) type = 'dosso';
            
            const bump = {
                id: now,
                lat: position.lat,
                lng: position.lng,
                intensity: intensity,
                timestamp: new Date().toISOString(),
                type: type
            };
            
            detectedBumps.push(bump);
            localStorage.setItem('roadBumps', JSON.stringify(detectedBumps));
            addBumpMarker(bump);
            renderBumpsList();
        }

        function addBumpMarker(bump) {
            const color = (bump.intensity || 0) > 25 ? 'red' : 'orange';
            const icon = L.divIcon({
                html: `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            });
            
            const marker = L.marker([bump.lat, bump.lng], { icon }).addTo(map);
            
            // FIX: uso template literals per evitare undefinednull
            const typeLabel = bump.type === 'buca_profonda' ? 'Buca Profonda' : (bump.type === 'dosso' ? 'Dosso' : 'Sussulto');
            const gForce = ((bump.intensity || 0) / 9.8).toFixed(1);
            const dateStr = bump.timestamp ? new Date(bump.timestamp).toLocaleString() : 'Data non disponibile';
            
            marker.bindPopup(`
                <div class="text-sm">
                    <strong>${typeLabel}</strong><br>
                    Intensità: ${gForce}g<br>
                    <small>${dateStr}</small>
                </div>
            `);
        }

        function checkProximity() {
            if (!currentPosition || detectedBumps.length === 0 || !isNavigating) return;
            
            let warningDist = BASE_WARNING_DISTANCE;
            if (currentSpeed > 0) {
                warningDist = Math.max(80, Math.min(400, (currentSpeed / 3.6) * 22));
            }
            
            let nearest = null;
            let minDist = Infinity;
            
            detectedBumps.forEach(bump => {
                if (!bump || typeof bump.lat !== 'number' || typeof bump.lng !== 'number') return;
                const dist = calculateDistance(currentPosition.lat, currentPosition.lng, bump.lat, bump.lng);
                if (dist < minDist && dist < warningDist) {
                    minDist = dist;
                    nearest = bump;
                }
            });
            
            if (nearest) {
                const timeToArrival = currentSpeed > 0 ? Math.round(minDist / (currentSpeed / 3.6)) : 0;
                showAlert(nearest, minDist, timeToArrival);
            } else {
                hideAlert();
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const φ1 = (lat1 || 0) * Math.PI/180;
            const φ2 = (lat2 || 0) * Math.PI/180;
            const Δφ = ((lat2 || 0)-(lat1 || 0)) * Math.PI/180;
            const Δλ = ((lon2 || 0)-(lon1 || 0)) * Math.PI/180;
            const a = Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function showAlert(bump, distance, seconds) {
            const banner = document.getElementById('alert-banner');
            const title = document.getElementById('alert-title');
            const desc = document.getElementById('alert-desc');
            
            if (!banner || !title || !desc) return;
            if (!bump) return;
            
            // FIX: stringhe sicure
            const tipo = bump.type === 'buca_profonda' ? 'Buca profonda' : (bump.type === 'dosso' ? 'Dosso' : 'Dissesto');
            const dist = Math.round(distance || 0);
            let msg = `⚠️ ${tipo} tra ${dist}m`;
            
            const secs = parseInt(seconds) || 0;
            if (secs > 0 && secs < 60) msg += ` (${secs}s)`;
            else if (secs >= 60) msg += ` (${Math.round(secs/60)}min)`;
            
            title.textContent = msg;
            
            const speed = parseFloat(currentSpeed) || 0;
            desc.textContent = speed > 5 ? `Rallenta! Stai andando a ${Math.round(speed)} km/h` : 'Rallentare nelle prossimità';
            
            if (banner.classList.contains('hidden')) {
                banner.classList.remove('hidden');
                if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
            }
        }

        function hideAlert() {
            const banner = document.getElementById('alert-banner');
            if (banner) banner.classList.add('hidden');
        }

        function updateUserPosition(pos) {
            if (!userMarker) {
                userMarker = L.circleMarker([pos.lat, pos.lng], {
                    radius: 8, fillColor: "#3b82f6", color: "#fff", weight: 2, fillOpacity: 0.8
                }).addTo(map);
            } else {
                userMarker.setLatLng([pos.lat, pos.lng]);
            }
            if (pathCoordinates.length < 2) map.setView([pos.lat, pos.lng], 17);
        }

        function renderBumpsList() {
            const container = document.getElementById('bumps-list');
            if (!container) return;
            
            if (!detectedBumps || detectedBumps.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <i data-lucide="map-pin" class="w-12 h-12 mx-auto mb-2 opacity-20"></i>
                        <p class="text-sm">Nessun dissesto rilevato</p>
                        <p class="text-xs mt-1">Avvia il tracking per iniziare</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            const sorted = [...detectedBumps]
                .filter(b => b && b.id && typeof b.lat === 'number' && typeof b.lng === 'number' && (b.intensity || 0) >= 20)
                .sort((a, b) => (b.id || 0) - (a.id || 0));
            
            container.innerHTML = sorted.map(bump => {
                const intensity = parseFloat(bump.intensity) || 0;
                const isSevere = intensity > 35;
                const isMedium = intensity > 25;
                
                let colorClass = 'bg-yellow-100 text-yellow-600';
                let iconName = 'alert-circle';
                if (isSevere) { colorClass = 'bg-red-100 text-red-600'; iconName = 'alert-triangle'; }
                else if (isMedium) { colorClass = 'bg-orange-100 text-orange-600'; }
                
                const gForce = (intensity / 9.8).toFixed(1);
                const dateStr = bump.timestamp ? new Date(bump.timestamp).toLocaleString() : 'Data sconosciuta';
                
                // FIX: typeLabel sicuro
                let typeLabel = 'Sussulto';
                if (bump.type === 'buca_profonda') typeLabel = 'Buca Profonda';
                else if (bump.type === 'dosso') typeLabel = 'Dosso';
                
                const lat = parseFloat(bump.lat);
                const lng = parseFloat(bump.lng);
                
                return `
                <div class="bg-white rounded-xl p-3 shadow-sm border border-gray-200 flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full ${colorClass} flex items-center justify-center shrink-0">
                        <i data-lucide="${iconName}" class="w-5 h-5"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-semibold text-gray-800 text-sm truncate">${typeLabel}</p>
                        <p class="text-xs text-gray-500">${dateStr} • ${gForce}g</p>
                    </div>
                    <button onclick="centerOnBump(${lat}, ${lng})" class="p-2 hover:bg-gray-100 rounded-lg text-gray-400 hover:text-blue-500">
                        <i data-lucide="map-pin" class="w-4 h-4"></i>
                    </button>
                </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }

        function centerOnBump(lat, lng) {
            if (isNaN(lat) || isNaN(lng)) {
                alert('Coordinate non valide');
                return;
            }
            map.setView([lat, lng], 18);
        }

        function exportData() {
            if (!detectedBumps || detectedBumps.length === 0) {
                alert('Nessun dato da esportare');
                return;
            }
            const dataStr = JSON.stringify(detectedBumps, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `roadbumps_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function clearData() {
            if (confirm('Cancellare tutti i dati?')) {
                detectedBumps = [];
                localStorage.removeItem('roadBumps');
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker && layer !== userMarker) map.removeLayer(layer);
                });
                renderBumpsList();
                hideAlert();
            }
        }

        window.addEventListener('beforeunload', (e) => {
            if (isRecording || isNavigating) {
                e.preventDefault();
                e.returnValue = 'Stai registrando. Uscire?';
            }
        });
    </script>
</body>
</html>
